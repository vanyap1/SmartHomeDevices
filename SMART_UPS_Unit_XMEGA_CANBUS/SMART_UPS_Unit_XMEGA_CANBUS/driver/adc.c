/*
 * adc.c
 *
 * Created: 20/07/2025 0:32:56
 *  Author: Ivan Prints
 */ 
#include "adc.h"
#include <util/delay.h>

#define ADC_REF_VOLTAGE 1.0  // ????????? ?????? ??????? (INT1V)

void adc_init(void)
{
	// ????????? ?????? ADCA
	ADCA.CTRLA = ADC_ENABLE_bm;

	// 12-????? ????????????, ??? ???????? ???????
	ADCA.CTRLB = ADC_RESOLUTION_8BIT_gc;

	// ????????? ?????? ??????? 1.0V (INT1V)
	ADCA.REFCTRL = ADC_REFSEL_INTVCC_gc;

	// ??????? ??????? (???? F_CPU 32–48 MHz — ????? DIV512)
	ADCA.PRESCALER = ADC_PRESCALER_DIV512_gc;

	// ????? ???????? ????: PORTA1 -> ADC1
	ADCA.CH0.MUXCTRL = ADC_CH_MUXPOS_PIN0_gc;

	// ??????? ?????: single-ended
	ADCA.CH0.CTRL = ADC_CH_INPUTMODE_SINGLEENDED_gc;
	
}

uint16_t adc_read(uint8_t channel)
{
	if (channel > 7) return 0; // ??????

	// ???????????? ??????????? ?????????????
	ADCA.CH0.MUXCTRL = channel << ADC_CH_MUXPOS_gp;

	// ?????????? ?????????
	ADCA.CH0.CTRL |= ADC_CH_START_bm;

	// ???????? ??????????
	while (!(ADCA.CH0.INTFLAGS & ADC_CH_CHIF_bm));

	// ???????? ????
	ADCA.CH0.INTFLAGS = ADC_CH_CHIF_bm;

	// ?????????? ?????????
	return ADCA.CH0.RES;
}

double adc_read_voltage(uint8_t channel)
{
	uint16_t val = adc_read(channel);
	return ((double)val / 4095.0) * ADC_REF_VOLTAGE;
	//return ((double)val / 255.0) * ADC_REF_VOLTAGE;
}
