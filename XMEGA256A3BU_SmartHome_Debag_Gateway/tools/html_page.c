const char psu_page[] PROGMEM = "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>Controller Dashboard</title>\n<style>\nbody {\nmargin: 0;\npadding: 2em;\nfont-family: sans-serif;\nbackground-color: #1e1e2f;\ncolor: #e0f7fa;\ndisplay: flex;\njustify-content: center;\n}\n.frame {\nmax-width: 1200px;\nwidth: 100%;\nbackground-color: #263238;\npadding: 1em;\nborder-radius: 12px;\nbox-shadow: 0 0 20px rgba(0, 255, 255, 0.1);\n}\nheader {\npadding: 1em;\ntext-align: center;\nfont-size: 1.5em;\ncolor: #4dd0e1;\n}\n.container {\ndisplay: grid;\ngrid-template-columns: repeat(3, 1fr);\ngap: 1em;\npadding: 1em;\n}\n.card {\nbackground-color: #2c3e50;\nborder-radius: 8px;\npadding: 1em;\nbox-shadow: 0 0 10px rgba(0,255,255,0.1);\n}\n.card h2 {\ncolor: #00bcd4;\nmargin-top: 0;\n}\n.data-field {\nmargin: 0.5em 0;\n}\n.label {\nfont-weight: bold;\ncolor: #80deea;\n}\n.status-indicator {\nwidth: 20px;\nheight: 20px;\nborder-radius: 50%;\nbackground: #ccc; /* Default to gray */\ndisplay: inline-block;\nmargin-left: 10px;\n}\n.status-indicator.on {\nbackground-color: #4caf50; /* Green for ON */\nbox-shadow: 0 0 10px rgba(76, 175, 80, 0.5);\n}\n.status-indicator.off {\nbackground-color: #f44336; /* Red for OFF */\nbox-shadow: 0 0 10px rgba(244, 67, 54, 0.5);\n}\n.indicator-container {\ndisplay: flex;\nflex-direction: column;\nalign-items: center;\n}\n.indicator-label {\nmargin-top: 5px;\ntext-align: center;\n}\n.btn {\nmargin: 0.3em;\npadding: 0.5em 1em;\nbackground-color: #00838f;\ncolor: white;\nborder: none;\nborder-radius: 4px;\ncursor: pointer;\n}\n.btn:hover {\nbackground-color: #00acc1;\n}\n.kotel-content {\ndisplay: grid;\ngrid-template-columns: 1fr 1fr;\ngap: 1em;\n}\n.ups-content {\ndisplay: grid;\ngrid-template-columns: 1fr 1fr;\ngap: 1em;\n}\n.status-list {\nborder: 1px solid #4dd0e1;\nborder-radius: 6px;\npadding: 0.8em;\nbackground-color: rgba(77, 208, 225, 0.05);\n}\n.status-item {\ndisplay: flex;\nalign-items: center;\nmargin: 0.3em 0;\n}\n.status-item .status-indicator {\nmargin-right: 8px;\nmargin-left: 0;\nwidth: 12px;\nheight: 12px;\n}\n.status-label {\nfont-size: 0.9em;\ncolor: #b0bec5;\n}\n.timestamp-container {\nposition: relative;\ntext-align: right;\nmargin-top: 1em;\npadding: 0.8em;\n}\n.timestamp {\nbackground-color: rgba(77, 208, 225, 0.1);\nborder: 1px solid rgba(77, 208, 225, 0.3);\nborder-radius: 6px;\npadding: 0.6em 1em;\nfont-family: monospace;\nfont-size: 0.85em;\ncolor: #80deea;\ndisplay: inline-block;\nbox-shadow: 0 2px 8px rgba(0, 255, 255, 0.1);\n}\n.timestamp-label {\nfont-size: 0.75em;\ncolor: #4dd0e1;\nmargin-bottom: 0.3em;\ndisplay: block;\n}\n.can-status-container {\ndisplay: flex;\njustify-content: space-between;\nalign-items: center;\nmargin-top: 1em;\npadding: 0.8em;\nbackground-color: rgba(77, 208, 225, 0.05);\nborder-radius: 6px;\nborder: 1px solid rgba(77, 208, 225, 0.2);\n}\n.can-status-item {\ndisplay: flex;\nalign-items: center;\ngap: 0.5em;\n}\n.can-status-label {\nfont-size: 0.85em;\ncolor: #b0bec5;\n}\n</style>\n</head>\n<body>\n<div class=\"frame\">\n<header>Controller Dashboard</header>\n<div class=\"container\">\n<div class=\"card\">\n<h2>UPS Status</h2>\n<div class=\"ups-content\">\n<div>\n<div class=\"data-field\"><span class=\"label\">Voltage:</span> <span id=\"batVoltage\"></span> V</div>\n<div class=\"data-field\"><span class=\"label\">Current:</span> <span id=\"batCurrent\"></span> A</div>\n<div class=\"data-field\"><span class=\"label\">SOC:</span> <span id=\"batEnergy\"></span> Ah</div>\n<div class=\"data-field\"><span class=\"label\">Source:</span> <span id=\"currentSource\"></span></div>\n<div class=\"data-field\"><span class=\"label\">Msg Interval:</span> <span id=\"upsMsgInteval\"></span> ms</div>\n</div>\n<div class=\"status-list\">\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"ups-bit0\"></div>\n<span class=\"status-label\">Manual RUN</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"ups-bit1\"></div>\n<span class=\"status-label\">KOTEL</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"ups-bit2\"></div>\n<span class=\"status-label\">Solar module</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"ups-bit3\"></div>\n<span class=\"status-label\">BAT ERROR</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"ups-bit4\"></div>\n<span class=\"status-label\">Invertor ERR</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"ups-bit5\"></div>\n<span class=\"status-label\">Invertor overheat</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"ups-bit6\"></div>\n<span class=\"status-label\">Charger ERR</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"ups-bit7\"></div>\n<span class=\"status-label\">Charger Overheat</span>\n</div>\n</div>\n</div>\n</div>\n\n<div class=\"card\">\n<h2>Circulation Pump</h2>\n<div class=\"data-field\"><span class=\"label\">Current:</span> <span id=\"pumpAmp\"></span> mA</div>\n<div class=\"data-field\"><span class=\"label\">State:</span> <span id=\"pumpState\"></span></div>\n<div class=\"data-field\"><span class=\"label\">Mode:</span> <span id=\"pumpMode\"></span></div>\n<button class=\"btn\" onclick=\"setRelay(1)\">Turn On Pump</button>\n<button class=\"btn\" onclick=\"resetRelay(1)\">Turn Off Pump</button>\n</div>\n\n<div class=\"card\">\n<h2>Sensor Module</h2>\n<div class=\"data-field\"><span class=\"label\">boilerTemperature:</span> <span id=\"boilerTemperature\"></span> &#176;C</div>\n<div class=\"data-field\"><span class=\"label\">coolantTemperature:</span> <span id=\"coolantTemperature\"></span> &#176;C</div>\n<div class=\"data-field\"><span class=\"label\">solarCollectorTemp:</span> <span id=\"solarCollectorTemp\"></span> &#176;C</div>\n<div class=\"data-field\"><span class=\"label\">lightLevel:</span> <span id=\"lightLevel\"></span> lx</div>\n<div class=\"data-field\"><span class=\"label\">Msg Interval:</span> <span id=\"sensorUnitMsgInteval\"></span> ms</div>\n</div>\n\n<div class=\"card\">\n<h2>Water Reservoir</h2>\n<div class=\"data-field\"><span class=\"label\">DIN:</span> <span id=\"waterTankDIN\"></span></div>\n<div class=\"data-field\"><span class=\"label\">DOUT:</span> <span id=\"waterTankDOUT\"></span></div>\n<div class=\"data-field\"><span class=\"label\">Pressure:</span> <span id=\"waterPress\"></span> Bar</div>\n<div class=\"data-field\"><span class=\"label\">Pressure Lo Limit:</span> <span id=\"waterPressLoLim\"></span> Bar</div>\n<div class=\"data-field\"><span class=\"label\">Pressure Delta:</span> <span id=\"waterPressDelta\"></span> Bar</div>\n<div class=\"data-field\"><span class=\"label\">Water Level:</span> <span id=\"waterLevel\"></span></div>\n<div class=\"data-field\"><span class=\"label\">Msg Interval:</span> <span id=\"waterTankMsgInteval\"></span> ms</div>\n</div>\n\n<div class=\"card\">\n<h2>Kotel</h2>\n<div class=\"kotel-content\">\n<div>\n<div class=\"data-field\"><span class=\"label\">Temperature:</span> <span id=\"kotelActTemp\"></span> &#176;C</div>\n<div class=\"data-field\"><span class=\"label\">Set High:</span> <span id=\"kotelTemHi\"></span> &#176;C</div>\n<div class=\"data-field\"><span class=\"label\">Set Low:</span> <span id=\"kotelTemLo\"></span> &#176;C</div>\n<div class=\"data-field\"><span class=\"label\">Delta:</span> <span id=\"kotelTemDelta\"></span> &#176;C</div>\n<div class=\"data-field\"><span class=\"label\">RUN temp:</span> <span id=\"kotelTemRun\"></span> &#176;C</div>\n<div class=\"data-field\"><span class=\"label\">Mode stop:</span> <span id=\"kotelTemStop\"></span> &#176;C</div>\n<div class=\"data-field\"><span class=\"label\">Msg Interval:</span> <span id=\"kotelMsgInteval\"></span> ms</div>\n\n</div>\n<div class=\"status-list\">\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"kotel-bit0\"></div>\n<span class=\"status-label\">RUN</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"kotel-bit1\"></div>\n<span class=\"status-label\">Prerun</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"kotel-bit2\"></div>\n<span class=\"status-label\">T1 ERROR</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"kotel-bit3\"></div>\n<span class=\"status-label\">T2 ERROR</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"kotel-bit4\"></div>\n<span class=\"status-label\">Flue Overheat</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"kotel-bit5\"></div>\n<span class=\"status-label\">REL1</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"kotel-bit6\"></div>\n<span class=\"status-label\">DOOR</span>\n</div>\n<div class=\"status-item\">\n<div class=\"status-indicator\" id=\"kotel-bit7\"></div>\n<span class=\"status-label\">REL stat</span>\n</div>\n</div>\n</div>\n</div>\n\n<div class=\"card\">\n<h2>I/O Control</h2>\n<div class=\"data-field\"><span class=\"label\">Input 1:</span> <span id=\"in1\"></span>\n<div class=\"status-indicator\" id=\"in0-indicator\"></div>\n</div>\n<div class=\"data-field\"><span class=\"label\">Input 2:</span> <span id=\"in2\"></span>\n<div class=\"status-indicator\" id=\"in1-indicator\"></div>\n</div>\n\n\n<div style=\"margin-top: 1em;\">\n<div class=\"data-field\">\n<span class=\"label\">Relay 1:</span>\n<div class=\"status-indicator\" id=\"out1-indicator\"></div>\n</div>\n<button class=\"btn\" onclick=\"setRelay(1, 1)\">Turn On Relay 1</button>\n<button class=\"btn\" onclick=\"setRelay(1, 0)\">Turn Off Relay 1</button>\n</div>\n\n<div style=\"margin-top: 1em;\">\n<div class=\"data-field\">\n<span class=\"label\">Relay 2:</span>\n<div class=\"status-indicator\" id=\"out2-indicator\"></div>\n</div>\n<button class=\"btn\" onclick=\"setRelay(2, 1)\">Turn On Relay 2</button>\n<button class=\"btn\" onclick=\"setRelay(2, 0)\">Turn Off Relay 2</button>\n</div>\n</div>\n</div>\n<div class=\"can-status-container\">\n<div class=\"can-status-item\">\n<span class=\"can-status-label\">Kotel CAN OK:</span>\n<div class=\"status-indicator\" id=\"kotel-can-indicator\"></div>\n</div>\n<div class=\"can-status-item\">\n<span class=\"can-status-label\">Sensor CAN OK:</span>\n<div class=\"status-indicator\" id=\"sensor-can-indicator\"></div>\n</div>\n<div class=\"can-status-item\">\n<span class=\"can-status-label\">Water Tank CAN OK:</span>\n<div class=\"status-indicator\" id=\"water-can-indicator\"></div>\n</div>\n<div class=\"can-status-item\">\n<span class=\"can-status-label\">UPS CAN OK:</span>\n<div class=\"status-indicator\" id=\"ups-can-indicator\"></div>\n</div>\n</div>\n<div class=\"timestamp-container\">\n<span class=\"timestamp-label\">Last Update:</span>\n<div class=\"timestamp\" id=\"timestamp\">--</div>\n</div>\n</div>\n</div>\n<script>\nasync function fetchData() {\ntry {\nconst res = await fetch('/get_vals');\nconst data = await res.json();\n\n// Update timestamp\ndocument.getElementById('timestamp').textContent = data.timestamp || 'No timestamp';\n\ndocument.getElementById('batVoltage').textContent = data.batVoltage;\ndocument.getElementById('batCurrent').textContent = data.batCurrent;\ndocument.getElementById('batEnergy').textContent = data.batEnergy || '-';\ndocument.getElementById('currentSource').textContent = data.currentSource || '—';\n\ndocument.getElementById('pumpAmp').textContent = data.pumpAmp || '-';\ndocument.getElementById('pumpState').textContent = data.pumpState ? 'On' : 'Off';\ndocument.getElementById('pumpMode').textContent = data.pumpMode || '—';\n\ndocument.getElementById('boilerTemperature').textContent = data.boilerTemperature;\ndocument.getElementById('coolantTemperature').textContent = data.coolantTemperature;\ndocument.getElementById('solarCollectorTemp').textContent = data.solarCollectorTemp;\ndocument.getElementById('lightLevel').textContent = data.lightLevel;\n\ndocument.getElementById('waterTankDIN').textContent = data.waterTankDIN;\ndocument.getElementById('waterTankDOUT').textContent = data.waterTankDOUT;\ndocument.getElementById('waterPress').textContent = data.waterPress;\ndocument.getElementById('waterPressLoLim').textContent = data.waterPressLoLim || data.watetPressLoLim;\ndocument.getElementById('waterPressDelta').textContent = data.waterPressDelta;\ndocument.getElementById('waterLevel').textContent = data.waterLevel;\n\n\ndocument.getElementById('kotelActTemp').textContent = data.kotelActTemp;\ndocument.getElementById('kotelTemLo').textContent = data.kotelTemLo;\ndocument.getElementById('kotelTemHi').textContent = data.kotelTemHi;\ndocument.getElementById('kotelTemRun').textContent = data.kotelTemRun;\ndocument.getElementById('kotelTemStop').textContent = data.kotelTemStop;\ndocument.getElementById('kotelTemDelta').textContent = data.kotelTemDelta;\n\n\n\n\ndocument.getElementById('kotelMsgInteval').textContent = data.kotelMsgInteval || 'N/A';\ndocument.getElementById('sensorUnitMsgInteval').textContent = data.sensorUnitMsgInteval || 'N/A';\ndocument.getElementById('waterTankMsgInteval').textContent = data.waterTankMsgInteval || 'N/A';\ndocument.getElementById('upsMsgInteval').textContent = data.upsMsgInteval || 'N/A';\n\n// Update CAN status indicators\nconst kotelCanIndicator = document.getElementById('kotel-can-indicator');\nconst sensorCanIndicator = document.getElementById('sensor-can-indicator');\nconst waterCanIndicator = document.getElementById('water-can-indicator');\nconst upsCanIndicator = document.getElementById('ups-can-indicator');\n\nif (kotelCanIndicator) {\nkotelCanIndicator.className = 'status-indicator ' + ((data.kotelMsgInteval || 0) > 5000 ? 'off' : 'on');\n}\nif (sensorCanIndicator) {\nsensorCanIndicator.className = 'status-indicator ' + ((data.sensorUnitMsgInteval || 0) > 5000 ? 'off' : 'on');\n}\nif (waterCanIndicator) {\nwaterCanIndicator.className = 'status-indicator ' + ((data.waterTankMsgInteval || 0) > 5000 ? 'off' : 'on');\n}\nif (upsCanIndicator) {\nupsCanIndicator.className = 'status-indicator ' + ((data.upsMsgInteval || 0) > 5000 ? 'off' : 'on');\n}\n\n// Update kotel status indicators\nconst kotelStatus = data.kotelStatus || 0;\nfor (let i = 0; i < 8; i++) {\nconst bit = (kotelStatus >> i) & 1;\nconst indicator = document.getElementById(`kotel-bit${i}`);\nif (indicator) {\nindicator.className = 'status-indicator ' + (bit === 1 ? 'on' : 'off');\n}\n}\n\n// Update UPS status indicators\nconst upsStatus = data.currentState || 0;\nfor (let i = 0; i < 8; i++) {\nconst bit = (upsStatus >> i) & 1;\nconst indicator = document.getElementById(`ups-bit${i}`);\nif (indicator) {\nindicator.className = 'status-indicator ' + (bit === 1 ? 'on' : 'off');\n}\n}\n\n//document.getElementById('in1').textContent = data.in1;\n//document.getElementById('in2').textContent = data.in2;\n\n// Update input status indicators\nconst in1Indicator = document.getElementById('in1-indicator');\nconst in0Indicator = document.getElementById('in0-indicator');\n\nif (in1Indicator) {\nin1Indicator.className = 'status-indicator ' + (data.in2 == 1 ? 'on' : 'off');\n}\nif (in0Indicator) {\nin0Indicator.className = 'status-indicator ' + (data.in1 == 1 ? 'on' : 'off');\n}\n\n// Update relay status indicators\nconst out1Indicator = document.getElementById('out1-indicator');\nconst out2Indicator = document.getElementById('out2-indicator');\n\nout1Indicator.className = 'status-indicator ' + (data.out1 == 1 ? 'on' : 'off');\nout2Indicator.className = 'status-indicator ' + (data.out2 == 1 ? 'on' : 'off');\n\n} catch (e) {\nconsole.error('Data fetch error', e);\n}\n}\n\nfunction setRelay(n, state) {\nfetch(`/set_rel${n}?state=${state}`)\n.then(response => {\nif (!response.ok) {\nthrow new Error('Network response was not ok');\n}\nreturn response.json();\n})\n.then(data => {\nconsole.log(`Relay ${n} set to ${state ? 'On' : 'Off'}`);\n})\n.catch(error => {\nconsole.error('Error setting relay:', error);\n});\n}\n\nfunction resetRelay(n) {\nfetch(`/reset_rel${n}`);\n}\n\nsetInterval(fetchData, 2000);\nfetchData();\n</script>\n</body>\n</html>\n";